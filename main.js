const translations = {
    ar: {
        // Nav Links
        home: "الرئيسية",
        products: "المنتجات",
        categories: "الأقسام",
        about: "من نحن",
        contact: "اتصل بنا",

        // Hero Section
        heroTitle: "مستقبل <span>الهواتف</span> بين يديك",
        heroSubtitle: "اكتشف أحدث الهواتف الذكية والإكسسوارات الأصلية بأفضل الأسعار وأعلى جودة.",
        shopNow: "تسوق الآن",
        learnMore: "اكتشف المزيد",

        // Stats
        statHappyClients: "عميل سعيد",
        statProducts: "منتج أصلي",
        statAwards: "جائزة جودة",

        // Categories
        phones: "هواتف ذكية",
        accessories: "إكسسوارات",
        tablets: "أجهزة لوحية",
        audio: "صوتيات",
        smartWatches: "ساعات ذكية",

        // Product Grid
        featuredProducts: "منتجات مختارة",
        addToCart: "أضف للسلة",
        new: "جديد",
        sale: "خصم",

        // Footer
        footerAbout: "العفيفي ستورز هو وجهتك الأولى للحصول على أحدث التقنيات وأفضل الهواتف الذكية في المنطقة.",
        quickLinks: "روابط سريعة",
        customerService: "خدمة العملاء",
        newsletter: "النشرة الإخبارية",
        newsletterDesc: "اشترك للحصول على آخر العروض والأخبار.",
        subscribe: "اشترك",
        copyright: "© 2026 العفيفي ستورز. جميع الحقوق محفوظة.",
        privacyPolicy: "سياسة الخصوصية",
        termsConditions: "الشروط والأحكام",
        faq: "الأسئلة الشائعة",
        emailPlaceholder: "البريد الإلكتروني",
        searchPlaceholder: "بحث...",

        // Others
        login: "دخول",
        register: "تسجيل",
        cart: "السلة",
        search: "بحث...",
        logout: "تسجيل الخروج",
        myProfile: "ملفي الشخصي",
        myOrders: "طلباتي",
        logoutConfirm: "هل أنت متأكد من تسجيل الخروج؟",
        logoutConfirmTitle: "تسجيل الخروج",

        // About Page
        aboutTitle: "قصة متجرنا",
        aboutDesc: "بدأنا برؤية بسيطة: توفير أحدث التقنيات العالمية بأعلى جودة وأفضل خدمة عملاء في المنطقة. اليوم، نحن فخورون بخدمة آلاف العملاء وتوفير تشكيلة واسعة من الهواتف والإكسسوارات الأصلية.",
        expYears: "سنين خبرة",
        branches: "فروع حول المملكة",
        valuesTitle: "قيمنا الأساسية",
        quality: "الجودة والأصالة",
        qualityDesc: "جميع منتجاتنا أصلية 100% ومعتمدة من الوكلاء الرسميين.",
        service: "خدمة متميزة",
        serviceDesc: "فريق دعم فني متواجد دائماً للإجابة على جميع استفساراتكم.",
        delivery: "توصيل سريع",
        deliveryDesc: "نضمن لك وصول طلبك في أسرع وقت ممكن وبأمان تام.",

        // Products Page
        brands: "الماركات",
        price: "السعر",
        applyFilters: "تطبيق الفلاتر",
        showing: "عرض",
        ofProducts: "من أصل",
        productsCount: "منتج",
        sortBy: "ترتيب حسب",
        latest: "الأحدث",
        priceLowHigh: "السعر من الأقل للأعلى",
        priceHighLow: "السعر من الأعلى للأقل",

        // Contact Page
        contactTitle: "تواصل معنا",
        fullName: "الاسم الكامل",
        namePlaceholder: "أدخل اسمك",
        message: "الرسالة",
        messagePlaceholder: "كيف يمكننا مساعدتك؟",
        sendMessage: "إرسال الرسالة",
        ourLocation: "موقعنا",
        locationDesc: "المملكة العربية السعودية، الرياض",
        callUs: "اتصل بنا",
        emailUs: "البريد الإلكتروني",
        searchFeatureComingSoon: "ميزة البحث ستتوفر قريباً!",

        // Admin General
        adminDashboard: "لوحة الإحصائيات",
        adminProducts: "إدارة المنتجات",
        adminOrders: "الطلبات",
        adminCategories: "الأقسام",
        adminCustomers: "العملاء",
        adminSettings: "الإعدادات",
        welcomeAdmin: "مرحباً بك، المدير",
        storeManagement: "إدارة المتجر",
        wishlist: "المفضلة",
        noFavorites: "لا توجد منتجات في المفضلة حالياً.",
        addedToWishlist: "تمت الإضافة للمفضلة!",
        removedFromWishlist: "تمت الإزالة من المفضلة",

        // Admin Stats
        totalSales: "إجمالي المبيعات",
        newOrders: "الطلبات الجديدة",
        totalProducts: "إجمالي المنتجات",
        activeCustomers: "العملاء النشطون",
        thisMonth: "هذا الشهر",
        today: "اليوم",
        allCategories: "من جميع الأقسام",
        activeSubscribers: "مشتركين نشطين",

        // Admin Tables
        recentOrders: "آخر الطلبات",
        viewAll: "عرض الكل",
        orderNum: "رقم الطلب",
        customer: "العميل",
        product: "المنتج",
        date: "التاريخ",
        amount: "المبلغ",
        status: "الحالة",
        completed: "مكتمل",
        pending: "قيد الانتظار",
        active: "نشط",
        delivered: "تم التوصيل",
        processing: "قيد المعالجة",
        cancelled: "ملغي",
        allStatuses: "كل الحالات",
        viewDetails: "تفاصيل",

        // Settings/Lists missing keys
        storeName: "اسم المتجر",
        officialEmail: "البريد الإلكتروني الرسمي",
        officialEmailValue: "support@alafify.com",
        officialPhone: "+966 50 000 0000",
        defaultCurrency: "العملة الافتراضية",
        defaultLanguage: "اللغة الافتراضية",
        maintenanceMode: "تفعيل وضع الصيانة",
        promoBanner: "البانر الترويجي (Hero)",
        bannerLink: "رابط البانر (URL)",
        promoImageLabel: "صورة البانر الرئيسي",
        saveChanges: "حفظ التغييرات",
        email: "البريد الإلكتروني",
        joinDate: "تاريخ الانضمام",
        productsCount: "عدد المنتجات",
        ordersCount: "الطلبات",
        arabic: "العربية",
        english: "الإنجليزية",
        productName: "اسم المنتج",
        stockCount: "الكمية بالمخزون",
        imageUrl: "رابط الصورة",
        description: "الوصف",
        save: "حفظ",
        cancel: "إلغاء",
        selectCategory: "اختر القسم",
        categoryName: "اسم القسم",
        categoryIcon: "أيقونة القسم (FontAwesome)",
        categoryProducts: "عدد المنتجات",
        selectBrand: "اختر العلامة التجارية",
        brandName: "اسم العلامة التجارية",
        building: "المبنى (رقم أو اسم)",
        floor: "الطابق",
        apartment: "رقم الشقة",
        location: "رابط الموقع أو الموقع الدقيق",
        locationPlaceholder: "رابط خرائط جوجل أو وصف دقيق للموقع",
        address: "العنوان التفصيلي (المدينة، الحي، الشارع)",

        // Privacy Policy Page
        privacyTitle: "سياسة الخصوصية",
        privacyIntro: "نحن في العفيفي ستورز نلتزم بحماية خصوصيتك وبياناتك الشخصية.",
        privacySection1: "جمع المعلومات: نقوم بجمع المعلومات التي تقدمها لنا عند التسجيل أو الشراء.",
        privacySection2: "استخدام المعلومات: نستخدم بياناتك لتحسين خدماتنا ومعالجة طلباتك.",
        privacySection3: "حماية البيانات: نستخدم أحدث تقنيات التشفير لضمان أمان معلوماتك.",

        // Terms & Conditions Page
        termsTitle: "الشروط والأحكام",
        termsIntro: "باستخدامك لموقعنا، فإنك توافق على الالتزام بالشروط التالية.",
        termsSection1: "شروط الاستخدام: يجب ألا يقل عمر المستخدم عن 18 عاماً.",
        termsSection2: "الدفع والأسعار: جميع الأسعار تشمل ضريبة القيمة المضافة.",
        termsSection3: "سياسة الإرجاع: يمكن إرجاع المنتجات خلال 14 يوماً من تاريخ الاستلام.",

        // FAQ Page
        faqTitle: "الأسئلة الشائعة",
        faqQ1: "هل المنتجات أصلية؟",
        faqA1: "نعم، جميع منتجاتنا أصلية 100% ومعتمدة من الوكلاء الرسميين.",
        faqQ2: "كم يستغرق التوصيل؟",
        faqA2: "يستغرق التوصيل عادة من 2 إلى 5 أيام عمل داخل المملكة.",
        faqQ3: "هل تتوفر خيارات الدفع عند الاستلام؟",
        faqA3: "نعم، نوفر خدمة الدفع عند الاستلام بالإضافة إلى الدفع الإلكتروني.",
        faqQ4: "كيف يمكنني تتبع طلبي؟",
        faqA4: "يمكنك تتبع طلبك من خلال صفحة 'طلباتي' في ملفك الشخصي.",

        // Buttons & Labels
        addNewProduct: "إضافة منتج جديد",
        addNewCategory: "إضافة قسم جديد",
        edit: "تعديل",
        delete: "حذف",
        password: "كلمة المرور",
        forgotPassword: "نسيت كلمة المرور؟",
        orderSummary: "ملخص الطلب",
        subtotal: "إجمالي المنتجات",
        delivery: "التوصيل",
        free: "مجاني",
        taxes: "الضرائب",
        total: "الإجمالي الكلي",
        orderTotalAmount: "الإجمالي المطلوب دفعه:",
        confirmOrder: "تأكيد الطلب",
        byConfirming: "من خلال تأكيد الطلب، فإنك توافق على",
        ourPrivate: "الخاصة بنا.",
        noProducts: "لا توجد منتجات متوفرة حالياً.",
        noCategories: "لا توجد أقسام متوفرة حالياً.",
        category: "القسم",
        itemActions: "الإجراءات",
        editProduct: "تعديل المنتج",
        editCategory: "تعديل القسم",
        update: "تحديث"
    },
    en: {
        // Nav Links
        home: "Home",
        products: "Products",
        categories: "Categories",
        about: "About",
        contact: "Contact",

        // Hero Section
        heroTitle: "The Future of <span>Phones</span> in Your Hands",
        heroSubtitle: "Discover the latest smartphones and original accessories with the best prices and highest quality.",
        shopNow: "Shop Now",
        learnMore: "Learn More",

        // Stats
        statHappyClients: "Happy Clients",
        statProducts: "Original Products",
        statAwards: "Quality Awards",

        // Categories
        phones: "Smartphones",
        accessories: "Accessories",
        tablets: "Tablets",
        audio: "Audio",
        smartWatches: "Smart Watches",

        // Product Grid
        featuredProducts: "Featured Products",
        addToCart: "Add to Cart",
        new: "New",
        sale: "Sale",

        // Footer
        footerAbout: "Al Afify Stores is your first destination for the latest technology and the best smartphones in the region.",
        quickLinks: "Quick Links",
        customerService: "Customer Service",
        newsletter: "Newsletter",
        newsletterDesc: "Subscribe to get the latest offers and news.",
        subscribe: "Subscribe",
        copyright: "© 2026 Al Afify Stores. All rights reserved.",
        privacyPolicy: "Privacy Policy",
        termsConditions: "Terms & Conditions",
        faq: "FAQ",
        emailPlaceholder: "Email address",
        searchPlaceholder: "Search...",

        // Others
        login: "Login",
        register: "Register",
        cart: "Cart",
        search: "Search...",
        logout: "Logout",
        myProfile: "My Profile",
        myOrders: "My Orders",
        logoutConfirm: "Are you sure you want to logout?",
        logoutConfirmTitle: "Logout",

        // About Page
        aboutTitle: "Our Story",
        aboutDesc: "We started with a simple vision: providing the latest global technologies with the highest quality and best customer service in the region. Today, we are proud to serve thousands of customers and provide a wide selection of original phones and accessories.",
        expYears: "Years Experience",
        branches: "Branches around Kingdom",
        valuesTitle: "Our Core Values",
        quality: "Quality & Authenticity",
        qualityDesc: "All our products are 100% original and certified from official dealers.",
        service: "Premium Service",
        serviceDesc: "A technical support team is always available to answer all your inquiries.",
        delivery: "Fast Delivery",
        deliveryDesc: "We guarantee that your order reaches you as quickly as possible and with total safety.",

        // Products Page
        brands: "Brands",
        price: "Price",
        applyFilters: "Apply Filters",
        showing: "Showing",
        ofProducts: "of",
        productsCount: "products",
        sortBy: "Sort By",
        latest: "Latest",
        priceLowHigh: "Price: Low to High",
        priceHighLow: "Price: High to Low",
        searchFeatureComingSoon: "Search feature coming soon!",

        // Contact Page
        contactTitle: "Contact Us",
        fullName: "Full Name",
        namePlaceholder: "Enter your name",
        message: "Message",
        messagePlaceholder: "How can we help you?",
        sendMessage: "Send Message",
        ourLocation: "Our Location",
        locationDesc: "Riyadh, Saudi Arabia",
        callUs: "Call Us",
        emailUs: "Email Us",

        // Admin General
        adminDashboard: "Statistics Dashboard",
        adminProducts: "Product Management",
        adminOrders: "Orders",
        adminCategories: "Categories",
        adminCustomers: "Customers",
        adminSettings: "Settings",
        welcomeAdmin: "Welcome, Admin",
        storeManagement: "Store Management",

        // Admin Stats
        totalSales: "Total Sales",
        newOrders: "New Orders",
        totalProducts: "Total Products",
        activeCustomers: "Active Customers",
        thisMonth: "This Month",
        today: "Today",
        allCategories: "From all categories",
        activeSubscribers: "Active subscribers",

        // Auth Modal
        password: "Password",
        forgotPassword: "Forgot Password?",

        // Cart
        orderSummary: "Order Summary",
        subtotal: "Subtotal",
        delivery: "Delivery",
        free: "Free",
        taxes: "Taxes",
        total: "Total Amount",
        orderTotalAmount: "Total Amount to Pay:",
        confirmOrder: "Confirm Order",
        byConfirming: "By confirming the order, you agree to our",
        ourPrivate: ".",
        noProducts: "No products available currently.",
        noCategories: "No categories available currently.",

        // Admin Tables
        recentOrders: "Recent Orders",
        viewAll: "View All",
        orderNum: "Order #",
        customer: "Customer",
        product: "Product",
        date: "Date",
        amount: "Amount",
        status: "Status",
        completed: "Completed",
        pending: "Pending",
        active: "Active",
        delivered: "Delivered",
        processing: "Processing",
        cancelled: "Cancelled",
        allStatuses: "All Statuses",
        viewDetails: "Details",

        // Settings/Lists missing keys
        storeName: "Store Name",
        officialEmail: "Official Email",
        officialEmailValue: "support@alafify.com",
        officialPhone: "+966 50 000 0000",
        defaultCurrency: "Default Currency",
        defaultLanguage: "Default Language",
        maintenanceMode: "Enable Maintenance Mode",
        promoBanner: "Hero Promo Banner",
        bannerLink: "Banner Link (URL)",
        promoImageLabel: "Hero Banner Image",
        saveChanges: "Save Changes",
        email: "Email",
        joinDate: "Join Date",
        productsCount: "Products Count",
        ordersCount: "Orders",
        arabic: "Arabic",
        english: "English",
        productName: "Product Name",
        stockCount: "Stock Quantity",
        imageUrl: "Image URL",
        description: "Description",
        save: "Save",
        cancel: "Cancel",
        selectCategory: "Select Category",
        selectBrand: "Select Brand",
        brandName: "Brand Name",
        categoryName: "Category Name",
        categoryIcon: "Category Icon (FontAwesome)",
        categoryProducts: "Products Count",
        building: "Building (Name or Number)",
        floor: "Floor",
        apartment: "Apartment Number",
        location: "Location Link or Description",
        locationPlaceholder: "Google Maps link or precise location description",
        address: "Detailed Address (City, District, Street)",

        // Privacy Policy Page
        privacyTitle: "Privacy Policy",
        privacyIntro: "At Al Afify Stores, we are committed to protecting your privacy and personal data.",
        privacySection1: "Information Collection: We collect information you provide during registration or purchase.",
        privacySection2: "Data Usage: We use your data to enhance our services and process your orders.",
        privacySection3: "Security: We use the latest encryption technologies to ensure your data safety.",

        // Terms & Conditions Page
        termsTitle: "Terms & Conditions",
        termsIntro: "By using our website, you agree to comply with the following terms.",
        termsSection1: "Usage Terms: Users must be at least 18 years old.",
        termsSection2: "Payments & Pricing: All prices include VAT where applicable.",
        termsSection3: "Return Policy: Products can be returned within 14 days of delivery.",

        // FAQ Page
        faqTitle: "Frequently Asked Questions",
        faqQ1: "Are the products original?",
        faqA1: "Yes, all our products are 100% original and certified from official dealers.",
        faqQ2: "How long does delivery take?",
        faqA2: "Delivery typically takes 2 to 5 business days within the Kingdom.",
        faqQ3: "Is cash on delivery available?",
        faqA3: "Yes, we offer cash on delivery along with electronic payment options.",
        faqQ4: "How can I track my order?",
        faqA4: "You can track your order through the 'My Orders' page in your profile.",

        // Buttons & Labels
        addNewProduct: "Add New Product",
        addNewCategory: "Add New Category",
        edit: "Edit",
        delete: "Delete",
        editProduct: "Edit Product",
        editCategory: "Edit Category",
        update: "Update",
        price: "Price",
        stock: "Stock",
        category: "Category",
        itemActions: "Actions",
        wishlist: "Wishlist",
        noFavorites: "No favorite products yet.",
        addedToWishlist: "Added to favorites!",
        removedFromWishlist: "Removed from favorites",
    }
};

const escapeHTML = (str) => {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
};

document.addEventListener('DOMContentLoaded', () => {
    // --- Route Guard & Initialization ---
    const path = window.location.pathname;
    const userRole = localStorage.getItem('phoneStoreUser');
    // Simplified Admin Check for flat structure
    const isAdminPath = path.includes('settings.html') || path.includes('admin-products.html') || path.includes('admin-categories.html') || path.includes('admin-dashboard.html');

    if (isAdminPath && userRole !== 'admin') {
        window.location.href = 'index.html';
        return;
    }

    const menuToggle = document.querySelector('.menu-toggle');
    const header = document.querySelector('header') || document.querySelector('.header');
    const navMenu = document.querySelector('.nav-menu');

    // Branding Management
    let currentLang = localStorage.getItem('phoneStoreLang') || 'ar';
    let siteName = localStorage.getItem('phoneStoreName') || 'العفيفي ستورز';

    const updateBranding = () => {
        const logoTexts = document.querySelectorAll('.site-name-root');
        logoTexts.forEach(span => {
            if (siteName.includes(' ')) {
                const parts = siteName.split(' ');
                const last = parts.pop();
                span.innerHTML = `${parts.join(' ')} <span class="text-gradient">${last}</span>`;
            } else {
                span.textContent = siteName;
            }
        });

        // Update document title
        const currentTitle = document.title;
        const pageName = currentTitle.includes('|') ? currentTitle.split('|')[0].trim() : currentTitle;

        // Don't append if the pageName is already the siteName (like on home if not translated yet)
        if (pageName && pageName !== siteName) {
            document.title = `${pageName} | ${siteName}`;
        } else {
            document.title = siteName;
        }
    };



    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('phoneStoreLang', lang);

        // Set document direction
        document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
        document.documentElement.lang = lang;

        // Update active class on all lang buttons in the DOM
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === lang);
        });

        // Update all elements with data-i18n attribute
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.dataset.i18n;
            if (translations[lang] && translations[lang][key]) {
                if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'email') || element.tagName === 'TEXTAREA') {
                    element.placeholder = translations[lang][key];
                } else {
                    element.innerHTML = translations[lang][key];
                }
            }
        });

        // Trigger transition animation (subtle fade)
        document.body.style.opacity = '0.9';
        setTimeout(() => {
            document.body.style.opacity = '1';
        }, 50);
    };

    // Initialize Language
    setLanguage(currentLang);

    // --- Sidebar Active State & Admin Logic ---
    const updateAdminSidebar = () => {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
        navItems.forEach(item => {
            const href = item.getAttribute('href');
            if (href && currentPath.includes(href)) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    };
    updateAdminSidebar();

    // Universal Lang Button Clicks (Delegation)
    document.addEventListener('click', (e) => {
        const langBtn = e.target.closest('.lang-btn');
        if (langBtn) {
            e.preventDefault();
            const lang = langBtn.getAttribute('data-lang');
            if (lang !== currentLang) {
                setLanguage(lang);
            }
        }
    });

    // --- Header Scroll Effect ---
    window.addEventListener('scroll', () => {
        if (header) {
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        }
    });

    // --- Mobile Menu ---
    if (menuToggle && navMenu) {
        menuToggle.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            menuToggle.classList.toggle('active');
        });
    }

    // --- Check Out Guard ---
    document.addEventListener('click', (e) => {
        if (e.target.closest('.checkout-btn')) {
            const user = localStorage.getItem('phoneStoreUser');
            if (!user) {
                e.preventDefault();
                showToast(currentLang === 'ar' ? 'يرجى تسجيل الدخول أولاً لإتمام الطلب' : 'Please login first to complete your order', 'warning');
                const authModal = document.getElementById('authModal');
                if (authModal) {
                    authModal.classList.add('active');
                } else {
                    if (typeof initAuthModal === 'function') initAuthModal();
                    document.getElementById('authModal')?.classList.add('active');
                }
            }
        }
    });

    // Close menu on link click
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
            if (navMenu) navMenu.classList.remove('active');
            if (menuToggle) menuToggle.classList.remove('active');
        });
    });

    // --- Cart Preview (Simplified for now) ---
    const cartBtn = document.querySelector('.nav-action-btn i.fa-shopping-cart')?.parentElement;
    if (cartBtn) {
        cartBtn.addEventListener('click', (e) => {
            // Only alert if it's a hashtag link
            if (cartBtn.getAttribute('href') === '#') {
                e.preventDefault();
                showToast(currentLang === 'ar' ? 'سلة التسوق ستتوفر قريباً!' : 'Shopping cart coming soon!', 'info');
            }
        });
    }

    // --- Shared Product Database (Supabase) ---
    let allProducts = [];
    let allCategories = [];
    let cartItems = JSON.parse(localStorage.getItem('phoneStoreCart') || '[]');
    let wishlistItems = JSON.parse(localStorage.getItem('phoneStoreWishlist') || '[]');

    const updateCartCount = () => {
        const count = cartItems.reduce((total, item) => total + item.quantity, 0);
        document.querySelectorAll('.cart-count').forEach(el => {
            el.textContent = count;
            el.style.display = count > 0 ? 'flex' : 'none';
        });
    };

    const updateWishlistCount = (count) => {
        document.querySelectorAll('.wishlist-count').forEach(el => {
            el.textContent = count;
            el.style.display = count > 0 ? 'flex' : 'none';
        });
    };

    updateCartCount();
    updateWishlistCount(wishlistItems.length);

    // --- Category Card Renderer (Updated for images) ---
    const renderCategoryCard = (cat, delayClass = '') => {
        let linkPrefix = '';

        const imageHtml = cat.image
            ? `<img src="${cat.image}" alt="${cat.name}" class="category-image">`
            : `<div class="category-icon"><i class="fas fa-folder"></i></div>`;

        return `
            <a href="${linkPrefix}products.html?category=${cat.id}" class="glass-card category-card animate-fadeInUp ${delayClass}">
                ${imageHtml}
                <div class="category-info">
                    <h3>${escapeHTML(cat.name)}</h3>
                    <p class="category-count">Items +${cat.count || 0}</p>
                </div>
            </a>
        `;
    };

    // --- Async Categories Renderer ---
    const renderCategories = async () => {
        const gridRoot = document.querySelector('.categories-grid');
        if (!gridRoot) return;

        // Show loading
        gridRoot.innerHTML = `<div class="text-center" style="grid-column: 1/-1; padding: var(--spacing-xxl);"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i></div>`;

        // Fetch from Supabase
        if (typeof fetchCategories === 'function') {
            allCategories = await fetchCategories();
        }

        if (allCategories.length === 0) {
            gridRoot.innerHTML = `<div class="text-center" style="grid-column: 1/-1; padding: var(--spacing-xxl); color: var(--text-muted);">
                <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
                <p data-i18n="noCategories">${translations[currentLang].noCategories}</p>
            </div>`;
            return;
        }

        // If on homepage, only show first 4
        const path = window.location.pathname;
        const isHomePage = path.endsWith('index.html') || path.endsWith('/') || (!path.includes('.html') && !path.includes('/admin/'));
        const categoriesToShow = allCategories;

        gridRoot.innerHTML = categoriesToShow.map((cat, i) => renderCategoryCard(cat, `stagger-${i + 1}`)).join('');
    };

    const renderHeader = () => {
        const headerRoot = document.getElementById('header-root');
        if (!headerRoot) return;

        const path = window.location.pathname;
        const prefix = '';

        const isHome = path.endsWith('index.html') || path.endsWith('/');
        const isProducts = path.includes('products.html');
        const isCategories = path.includes('categories.html');
        const isAbout = path.includes('about.html');
        const isContact = path.includes('contact.html');

        headerRoot.innerHTML = `
            <header class="header">
                <div class="container">
                    <a href="${prefix}index.html" class="logo">
                        <div class="logo-icon"><i class="fas fa-mobile-alt"></i></div>
                        <span class="site-name-root">${siteName}</span>
                    </a>

                    <nav class="nav-menu desktop-only">
                        <a href="${prefix}index.html" class="nav-link ${isHome ? 'active' : ''}" data-i18n="home">${translations[currentLang].home}</a>
                        <a href="${prefix}products.html" class="nav-link ${isProducts ? 'active' : ''}" data-i18n="products">${translations[currentLang].products}</a>
                        <a href="${prefix}categories.html" class="nav-link ${isCategories ? 'active' : ''}" data-i18n="categories">${translations[currentLang].categories}</a>
                    </nav>

                    <div class="nav-actions">
                        <div class="lang-switcher">
                            <button class="lang-btn ${currentLang === 'ar' ? 'active' : ''}" data-lang="ar">AR</button>
                            <button class="lang-btn ${currentLang === 'en' ? 'active' : ''}" data-lang="en">EN</button>
                        </div>
                        
                        <div class="desktop-only flex" style="align-items: center; gap: var(--spacing-sm);">
                            <a href="#" class="nav-action-btn"><i class="fas fa-search"></i></a>
                            <a href="${prefix}favorites.html" class="nav-action-btn">
                                <i class="far fa-heart"></i>
                                <span class="wishlist-count">0</span>
                            </a>
                            <a href="${prefix}cart.html" class="nav-action-btn">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="cart-count">0</span>
                            </a>
                            ${(() => {
                const user = localStorage.getItem('phoneStoreUser');
                if (user === 'admin') {
                    return `<a href="${prefix}admin-products.html" class="btn btn-secondary btn-sm" style="margin: 0 10px; white-space: nowrap;"><i class="fas fa-user-shield"></i> ${translations[currentLang].adminDashboard}</a>`;
                } else if (user) {
                    return `
                        <div class="user-dropdown-container">
                            <button class="nav-action-btn user-dropdown-btn">
                                <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
                            </button>
                            <div class="user-dropdown-menu">
                                <div class="user-info-header" style="padding: 12px 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 8px;">
                                    <p style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; max-width: 180px;">${user}</p>
                                </div>
                                <a href="${prefix}profile.html" class="user-dropdown-item">
                                    <i class="fas fa-user"></i>
                                    <span data-i18n="myProfile">${translations[currentLang].myProfile}</span>
                                </a>
                                <a href="${prefix}orders.html" class="user-dropdown-item">
                                    <i class="fas fa-box"></i>
                                    <span data-i18n="myOrders">${translations[currentLang].myOrders}</span>
                                </a>
                                <button class="user-dropdown-item logout-trigger-btn logout">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span data-i18n="logout">${translations[currentLang].logout}</span>
                                </button>
                            </div>
                        </div>
                    `;
                }
                return `<button class="btn btn-primary btn-sm login-trigger-btn" data-i18n="login" style="margin: 0 10px; white-space: nowrap;">${translations[currentLang].login}</button>`;
            })()}
                        </div>
                    </div>
                </div>
            </header>
        `;
    };

    const renderMobileNav = () => {
        // If it's an admin page, we don't show the standard mobile nav (it has its own)
        if (window.location.pathname.includes('/admin/')) return;

        const mobileNavRoot = document.getElementById('mobile-nav-root');
        if (!mobileNavRoot) {
            const div = document.createElement('div');
            div.id = 'mobile-nav-root';
            document.body.appendChild(div);
        }

        const path = window.location.pathname;
        const prefix = '';
        const isHome = path.endsWith('index.html') || path.endsWith('/');
        const isProducts = path.includes('products.html');
        const isCategories = path.includes('categories.html');
        const isFavorites = path.includes('favorites.html');
        const isCart = path.includes('cart.html');

        const user = localStorage.getItem('phoneStoreUser');

        document.getElementById('mobile-nav-root').innerHTML = `
            <div class="mobile-bottom-nav">
                <a href="${prefix}index.html" class="nav-item ${isHome ? 'active' : ''}">
                    <i class="fas fa-home"></i>
                    <span data-i18n="home">${translations[currentLang].home}</span>
                </a>
                <a href="${prefix}products.html" class="nav-item ${isProducts ? 'active' : ''}">
                    <i class="fas fa-th-large"></i>
                    <span data-i18n="products">${translations[currentLang].products}</span>
                </a>
                <a href="${prefix}categories.html" class="nav-item ${isCategories ? 'active' : ''}">
                    <i class="fas fa-list"></i>
                    <span data-i18n="categories">${translations[currentLang].categories}</span>
                </a>
                <a href="${prefix}favorites.html" class="nav-item ${isFavorites ? 'active' : ''}">
                    <i class="far fa-heart"></i>
                    <span class="wishlist-count">0</span>
                </a>
                <a href="${prefix}cart.html" class="nav-item ${isCart ? 'active' : ''}">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
                <a href="${user ? prefix + 'profile.html' : '#'}" class="nav-item nav-item-featured ${!user ? 'login-trigger-btn' : ''}">
                    <i class="fas ${user ? 'fa-user-circle' : 'fa-user-plus'}"></i>
                    <span>${user ? translations[currentLang].myProfile : translations[currentLang].login}</span>
                </a>
            </div>
        `;
    };

    const renderFooter = () => {
        const footerRoot = document.getElementById('footer-root');
        if (!footerRoot) return;

        const path = window.location.pathname;
        const prefix = '';

        footerRoot.innerHTML = `
            <footer class="footer">
                <div class="container">
                    <div class="footer-grid">
                        <div class="footer-info">
                            <a href="${prefix}index.html" class="logo" style="margin-bottom: var(--spacing-md);">
                                <div class="logo-icon"><i class="fas fa-mobile-alt"></i></div>
                                <span class="site-name-root">${siteName}</span>
                            </a>
                            <p class="footer-desc" data-i18n="aboutDesc">${translations[currentLang].aboutDesc}</p>
                            <div class="social-links">
                                <a href="#"><i class="fab fa-facebook-f"></i></a>
                                <a href="#"><i class="fab fa-twitter"></i></a>
                                <a href="#"><i class="fab fa-instagram"></i></a>
                                <a href="#"><i class="fab fa-youtube"></i></a>
                            </div>
                        </div>

                        <div class="footer-links">
                            <h4 class="footer-title" data-i18n="quickLinks">${translations[currentLang].quickLinks}</h4>
                            <ul>
                                <li><a href="${prefix}index.html" data-i18n="home">${translations[currentLang].home}</a></li>
                                <li><a href="${prefix}products.html" data-i18n="products">${translations[currentLang].products}</a></li>
                                <li><a href="${prefix}categories.html" data-i18n="categories">${translations[currentLang].categories}</a></li>
                                <li><a href="${prefix}about.html" data-i18n="about">${translations[currentLang].about}</a></li>
                            </ul>
                        </div>

                        <div class="footer-links">
                            <h4 class="footer-title" data-i18n="customerService">${translations[currentLang].customerService}</h4>
                            <ul>
                                <li><a href="${prefix}contact.html" data-i18n="contact">${translations[currentLang].contact}</a></li>
                                <li><a href="${prefix}privacy-policy.html" data-i18n="privacyPolicy">${translations[currentLang].privacyPolicy}</a></li>
                                <li><a href="${prefix}terms-conditions.html" data-i18n="termsConditions">${translations[currentLang].termsConditions}</a></li>
                                <li><a href="${prefix}faq.html" data-i18n="faq">${translations[currentLang].faq}</a></li>
                            </ul>
                        </div>

                        <div class="footer-links">
                            <h4 class="footer-title" data-i18n="newsletter">${translations[currentLang].newsletter}</h4>
                            <p data-i18n="newsletterDesc" style="margin-bottom: var(--spacing-sm); font-size: 0.875rem; color: var(--text-secondary);">${translations[currentLang].newsletterDesc}</p>
                            <div class="form-group" style="display: flex; gap: 5px;">
                                <input type="email" class="form-input" placeholder="${translations[currentLang].emailPlaceholder}" data-i18n="emailPlaceholder">
                                <button class="btn btn-primary btn-sm newsletter-btn" data-i18n="subscribe">${translations[currentLang].subscribe}</button>
                            </div>
                        </div>
                    </div>

                    <div class="footer-bottom">
                        <p data-i18n="copyright">© 2026 ${siteName}. ${currentLang === 'ar' ? 'جميع الحقوق محفوظة.' : 'All rights reserved.'}</p>
                        <div class="payment-methods">
                            <div class="payment-method"><i class="fab fa-cc-visa"></i></div>
                            <div class="payment-method"><i class="fab fa-cc-mastercard"></i></div>
                            <div class="payment-method"><i class="fab fa-cc-paypal"></i></div>
                            <div class="payment-method"><i class="fab fa-cc-apple-pay"></i></div>
                        </div>
                    </div>
                </div>
            </footer>
        `;
    };

    const renderProductCard = (p, staggerClass = '') => {
        const categoryObj = allCategories.find(c => c.id === p.category);
        const categoryName = categoryObj ? categoryObj.name : p.category;
        const isWishlisted = wishlistItems.some(item => item.id === p.id);

        return `
            <div class="product-card animate-fadeInUp ${staggerClass}">
                <div class="product-image">
                    <img src="${p.image}" alt="${p.name}">
                    <div class="product-actions">
                        <button class="product-action-btn wishlist-btn ${isWishlisted ? 'active' : ''}" data-id="${p.id}">
                            <i class="${isWishlisted ? 'fas' : 'far'} fa-heart"></i>
                        </button>
                        <a href="product-detail.html?id=${p.id}" class="product-action-btn"><i class="fas fa-eye"></i></a>
                    </div>
                </div>
                <div class="product-info">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span class="product-category">${categoryName}</span>
                        <span class="status-badge ${p.in_stock ? 'status-completed' : 'status-failed'}" style="font-size: 0.75rem; padding: 2px 8px;">
                            ${p.in_stock ? (translations[currentLang].inStock || 'متوفر') : (translations[currentLang].outOfStock || 'نفذت')}
                        </span>
                    </div>
                    <h3 class="product-name"><a href="product-detail.html?id=${p.id}">${escapeHTML(p.name)}</a></h3>
                    <div class="product-rating">
                        <div class="stars">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                        </div>
                        <span class="rating-count">(124)</span>
                    </div>
                    <div class="product-price">
                        <span class="current-price">$${parseFloat(p.price).toLocaleString()}</span>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: var(--spacing-md);" 
                        data-i18n="addToCart" ${!p.in_stock ? 'disabled' : ''}>
                        ${translations[currentLang].addToCart}
                    </button>
                </div>
            </div>
        `;
    };

    const renderProductGrid = async () => {
        const featuredRoot = document.getElementById('featured-products-root');
        const productsGridRoot = document.getElementById('products-grid-root');
        const paginationRoot = document.getElementById('pagination-root');
        const statsHeader = document.querySelector('.products-header');

        const loadingHTML = `<div class="text-center" style="grid-column: 1/-1; padding: var(--spacing-xxl);"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i></div>`;
        const emptyHTML = `<div class="text-center" style="grid-column: 1/-1; padding: var(--spacing-xxl); color: var(--text-muted);">
            <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
            <p data-i18n="noProducts">${translations[currentLang].noProducts}</p>
        </div>`;

        // Show loading
        if (featuredRoot) featuredRoot.innerHTML = loadingHTML;
        if (productsGridRoot) productsGridRoot.innerHTML = loadingHTML;

        // Fetch from Supabase
        if (typeof fetchProducts === 'function') {
            allProducts = await fetchProducts();
        }

        // Featured products (usually on homepage)
        if (featuredRoot) {
            if (allProducts.length === 0) {
                featuredRoot.innerHTML = emptyHTML;
            } else {
                featuredRoot.innerHTML = allProducts.slice(0, 4).map((p, i) => renderProductCard(p, `stagger-${i + 1}`)).join('');
            }
        }

        // Main products grid with filtering
        if (productsGridRoot) {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryFilter = urlParams.get('category');

            let filteredProducts = allProducts;
            if (categoryFilter) {
                filteredProducts = allProducts.filter(p => p.category == categoryFilter);
            }

            if (filteredProducts.length === 0) {
                productsGridRoot.innerHTML = emptyHTML;
                if (paginationRoot) paginationRoot.style.display = 'none';
                if (statsHeader) statsHeader.style.display = 'none';
            } else {
                productsGridRoot.innerHTML = filteredProducts.map(p => renderProductCard(p)).join('');
                if (paginationRoot) paginationRoot.style.display = 'flex';
                if (statsHeader) {
                    statsHeader.style.display = 'flex';
                    const rangeEl = statsHeader.querySelector('.current-range');
                    const totalEl = statsHeader.querySelector('.total-count');
                    if (rangeEl) rangeEl.textContent = `1-${Math.min(12, filteredProducts.length)}`;
                    if (totalEl) totalEl.textContent = filteredProducts.length;
                }
            }
        }
    };

    // --- Favorites/Wishlist Renderer ---
    const renderFavorites = () => {
        const grid = document.querySelector('.products-grid');
        if (!grid) return;

        const wishlistItems = JSON.parse(localStorage.getItem('phoneStoreWishlist') || '[]');

        if (wishlistItems.length === 0) {
            grid.innerHTML = `
                <div class="text-center" style="grid-column: 1/-1; padding: var(--spacing-xxl); color: var(--text-muted);">
                    <i class="far fa-heart" style="font-size: 3rem; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
                    <p data-i18n="noFavorites">${translations[currentLang].noFavorites}</p>
                    <a href="products.html" class="btn btn-primary" style="margin-top: var(--spacing-lg);" data-i18n="shopNow">${translations[currentLang].shopNow}</a>
                </div>
            `;
            return;
        }

        grid.innerHTML = wishlistItems.map((p, i) => renderProductCard(p, `stagger-${i + 1}`)).join('');
    };

    // --- Admin Rendering Functions ---
    const renderAdminProducts = async () => {
        const tbody = document.querySelector('.admin-table-container table tbody');
        if (!tbody) return;

        // Populate category select in modal while we are here
        const select = document.getElementById('productCategorySelect');
        if (select) {
            select.innerHTML = `<option value="" data-i18n="selectCategory">${translations[currentLang].selectCategory}</option>` +
                allCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // Show loading
        tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i></td></tr>`;

        if (typeof fetchProducts === 'function') {
            allProducts = await fetchProducts();
        }

        if (allProducts.length === 0) {
            tbody.innerHTML = '';
            const container = document.querySelector('.admin-table-container');
            if (!container.querySelector('.text-center:not(tbody *)')) {
                const empty = document.createElement('div');
                empty.className = 'text-center';
                empty.style.padding = 'var(--spacing-xl)';
                empty.style.color = 'var(--text-muted)';
                empty.innerHTML = `
                    <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p>${currentLang === 'ar' ? 'لا توجد منتجات حالياً. اضغط "إضافة منتج جديد" للبدء.' : 'No products found. Click "Add New Product" to start.'}</p>
                `;
                container.appendChild(empty);
            }
            return;
        }

        // Remove empty state if exists
        const emptyState = document.querySelector('.admin-table-container > .text-center');
        if (emptyState) emptyState.remove();

        tbody.innerHTML = allProducts.map(p => {
            const categoryObj = allCategories.find(c => c.id == p.category);
            const categoryName = categoryObj ? categoryObj.name : p.category;

            return `
                <tr data-id="${p.id}">
                    <td class="flex" style="gap: 10px; align-items: center;">
                        <img src="${p.image}" class="product-img-table" onerror="this.src='https://via.placeholder.com/50'">
                        <span>${escapeHTML(p.name)}</span>
                    </td>
                    <td>${escapeHTML(categoryName)}</td>
                    <td>$${parseFloat(p.price).toLocaleString()}</td>
                    <td>
                        <span class="status-badge ${p.in_stock ? 'status-completed' : 'status-failed'}">
                            ${p.in_stock ? (translations[currentLang].inStock || 'متوفر') : (translations[currentLang].outOfStock || 'نفذت')}
                        </span>
                    </td>
                    <td><span class="status-badge status-completed" data-i18n="active">${translations[currentLang].active}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="admin-action-btn" data-action="edit" data-id="${p.id}" style="color: var(--accent-color);"><i class="fas fa-edit"></i></button>
                            <button class="admin-action-btn" data-action="delete" data-id="${p.id}" style="color: var(--danger-color);"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    };

    const renderAdminCategories = async () => {
        const grid = document.getElementById('categoryGridAdmin');
        if (!grid) return;

        // Show loading
        grid.innerHTML = `<div class="text-center" style="grid-column: 1/-1; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i></div>`;

        if (typeof fetchCategories === 'function') {
            allCategories = await fetchCategories();
        }

        if (allCategories.length === 0) {
            grid.innerHTML = `<div class="text-center" style="grid-column: 1/-1; padding: var(--spacing-xxl); color: var(--text-muted);">
                <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
                <p data-i18n="noCategories">${translations[currentLang].noCategories}</p>
            </div>`;
            return;
        }

        grid.innerHTML = allCategories.map(cat => {
            const imageHtml = cat.image
                ? `<img src="${cat.image}" alt="${cat.name}" class="category-image" style="width: 50px; height: 50px;">`
                : `<div class="category-icon" style="width: 50px; height: 50px; font-size: 1.25rem;"><i class="fas fa-folder"></i></div>`;

            return `
                <div class="glass-card flex-between" data-id="${cat.id}" style="padding: 1.25rem;">
                    <div class="flex" style="gap: 15px; align-items: center;">
                        ${imageHtml}
                        <div>
                            <h3 style="font-size: 1.1rem;">${cat.name}</h3>
                            <p style="font-size: 0.8rem; color: var(--text-muted);">Items: ${cat.count || 0}</p>
                        </div>
                    </div>
                    <div class="action-btns">
                        <button class="admin-action-btn" data-action="edit" data-id="${cat.id}" style="color: var(--accent-color);"><i class="fas fa-edit"></i></button>
                        <button class="admin-action-btn" data-action="delete" data-id="${cat.id}" style="color: var(--danger-color);"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    };


    // --- Async Initialization ---
    const initApp = async () => {
        renderHeader();
        renderFooter();
        renderMobileNav();

        // Always fetch categories first for name resolution
        if (typeof fetchCategories === 'function' && allCategories.length === 0) {
            allCategories = await fetchCategories();
        }

        const path = window.location.pathname;
        if (path.includes('admin-products.html')) {
            await renderAdminProducts();
            if (typeof populateProductCategories === 'function') populateProductCategories();
        } else if (path.includes('admin-categories.html')) {
            await renderAdminCategories();
        } else if (path.includes('favorites.html')) {
            renderFavorites();
        } else if (path.includes('profile.html')) {
            const user = localStorage.getItem('phoneStoreUser');
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            // Populate profile page data
            const nameEl = document.getElementById('profileUserName');
            const emailEl = document.getElementById('profileUserEmail');
            if (nameEl) nameEl.textContent = user;
            if (emailEl) emailEl.textContent = user.includes('@') ? user : '';

            const avatarImg = document.querySelector('#userProfileAvatar img');
            if (avatarImg) avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user)}&background=667eea&color=fff`;
        } else if (path.includes('product-detail.html')) {
            await loadProductDetail();
        } else if (path.includes('settings.html')) {
            const storeNameInput = document.getElementById('storeNameInput');
            if (storeNameInput) storeNameInput.value = siteName;

            const heroLinkInput = document.getElementById('heroLinkInput');
            if (heroLinkInput) heroLinkInput.value = localStorage.getItem('phoneStoreHeroLink') || '';

            const preview = document.getElementById('heroPreview');
            const savedImg = localStorage.getItem('phoneStoreHeroImage');
            if (preview && savedImg) {
                preview.innerHTML = `<img src="${savedImg}" style="width: 100%; height: 100%; object-fit: cover;">`;
            }
        } else if (path.includes('checkout.html')) {
            if (cartItems.length === 0) {
                window.location.href = 'index.html';
                return;
            }
            updateCartTotals();
        } else {
            try {
                await renderProductGrid();
                await renderCategories();
            } catch (err) {
                console.error("Home render error:", err);
            }
        }

        updateBranding();
        renderHeroPromo();
    };

    const renderHeroPromo = () => {
        const heroContainer = document.querySelector('.hero-image');
        // If container exists, we are on the home page (or a page with a hero section)
        if (!heroContainer) return;

        const promoImg = localStorage.getItem('phoneStoreHeroImage');
        const promoLink = localStorage.getItem('phoneStoreHeroLink') || '#';

        if (promoImg) {
            heroContainer.innerHTML = `
                <div class="hero-glow"></div>
                <a href="${promoLink}">
                    <img src="${promoImg}" alt="Promo" class="hero-promo-img">
                </a>
            `;
        }
    };

    // --- Product Modal Dynamic Fields Logic ---
    const initProductModal = () => {
        const categorySelect = document.getElementById('productCategorySelect');
        const dynamicFieldsContainer = document.getElementById('dynamicFieldsContainer');
        const brandSelect = document.getElementById('productBrandSelect');
        const addBrandBtn = document.getElementById('addBrandBtn');
        const addBrandModal = document.getElementById('addBrandModal');
        const addBrandForm = document.getElementById('addBrandForm');
        const productImagesInput = document.getElementById('productImagesInput');
        const imagesPreview = document.getElementById('imagesPreview');

        if (!categorySelect) return;

        // Populate Categories helper
        const populateCategories = () => {
            const currentVal = categorySelect.value;
            categorySelect.innerHTML = `<option value="">${translations[currentLang].selectCategory || 'اختر القسم'}</option>`;
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
            if (currentVal) categorySelect.value = currentVal;
        };
        window.populateProductCategories = populateCategories;
        populateCategories();

        // Store selected files
        let selectedFiles = [];

        // Category change handler - show/hide dynamic fields
        categorySelect.addEventListener('change', async (e) => {
            const categoryId = e.target.value;

            if (categoryId) {
                dynamicFieldsContainer.style.display = 'block';

                // Load all brands (Global)
                if (typeof fetchBrands === 'function') {
                    const brands = await fetchBrands(); // Don't pass categoryId
                    brandSelect.innerHTML = `<option value="">${translations[currentLang].selectBrand || 'اختر العلامة التجارية'}</option>`;
                    brands.forEach(brand => {
                        brandSelect.innerHTML += `<option value="${brand.id}">${brand.name}</option>`;
                    });
                }
            } else {
                dynamicFieldsContainer.style.display = 'none';
            }
        });

        // Add Brand Button Click
        if (addBrandBtn && addBrandModal) {
            addBrandBtn.addEventListener('click', () => {
                addBrandModal.classList.add('active');
            });
        }

        // Add Brand Form Submit
        if (addBrandForm) {
            addBrandForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const brandName = addBrandForm.brandName.value.trim();
                const categoryId = categorySelect.value;

                if (!brandName) {
                    showToast(currentLang === 'ar' ? 'يرجى إدخال اسم العلامة أولاً' : 'Please enter brand name first', 'error');
                    return;
                }

                const submitBtn = addBrandForm.querySelector('[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = currentLang === 'ar' ? 'جاري الإضافة...' : 'Adding...';

                if (typeof addBrand === 'function') {
                    const result = await addBrand({ name: brandName, category_id: categoryId });
                    if (result) {
                        // Add to select
                        const option = document.createElement('option');
                        option.value = result.id;
                        option.textContent = result.name;
                        option.selected = true;
                        brandSelect.appendChild(option);

                        showToast(currentLang === 'ar' ? 'تم إضافة العلامة التجارية بنجاح' : 'Brand added successfully');
                        addBrandForm.reset();
                        addBrandModal.classList.remove('active');
                    } else {
                        showToast(currentLang === 'ar' ? 'حدث خطأ أثناء الإضافة' : 'Error adding brand', 'error');
                    }
                }

                submitBtn.disabled = false;
                submitBtn.textContent = currentLang === 'ar' ? 'إضافة' : 'Add';
            });
        }

        // Image Preview Handler
        if (productImagesInput && imagesPreview) {
            productImagesInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                selectedFiles = [...selectedFiles, ...files];
                updateImagesPreview();
            });
        }

        const updateImagesPreview = () => {
            if (!imagesPreview) return;
            imagesPreview.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-image" data-index="${index}"><i class="fas fa-times"></i></div>
                    `;
                    imagesPreview.appendChild(div);

                    // Remove image handler
                    div.querySelector('.remove-image').addEventListener('click', () => {
                        selectedFiles.splice(index, 1);
                        updateImagesPreview();
                    });
                };
                reader.readAsDataURL(file);
            });
        };

        // Store selectedFiles globally for form submission
        window.getSelectedProductImages = () => selectedFiles;
        window.clearSelectedProductImages = () => {
            selectedFiles = [];
            if (imagesPreview) imagesPreview.innerHTML = '';
        };
    };

    initProductModal();

    // --- Global Search System ---
    const initSearch = () => {
        // Inject Search Overlay
        if (!document.getElementById('searchOverlay')) {
            const overlay = document.createElement('div');
            overlay.id = 'searchOverlay';
            overlay.className = 'search-overlay';
            overlay.innerHTML = `
                <button class="search-overlay-close">&times;</button>
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" class="search-overlay-input" 
                               data-i18n="searchPlaceholder" 
                               placeholder="${translations[currentLang].searchPlaceholder}">
                    </div>
                    <div class="search-results-preview"></div>
                </div>
            `;
            document.body.appendChild(overlay);

            const searchInput = overlay.querySelector('.search-overlay-input');
            const closeBtn = overlay.querySelector('.search-overlay-close');
            const resultsPreview = overlay.querySelector('.search-results-preview');

            // Open Search logic
            const openSearch = () => {
                overlay.classList.add('active');
                setTimeout(() => searchInput.focus(), 100);
            };

            const closeSearch = () => {
                overlay.classList.remove('active');
                searchInput.value = '';
                resultsPreview.innerHTML = '';
            };

            // Global search buttons
            document.querySelectorAll('.nav-action-btn i.fa-search').forEach(icon => {
                const btn = icon.parentElement;
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        openSearch();
                    });
                }
            });

            closeBtn.addEventListener('click', closeSearch);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeSearch();
            });

            // ESC key to close
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overlay.classList.contains('active')) closeSearch();
            });



            // Real-time filtering logic
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();

                // If on products page, filter the actual grid too
                if (window.location.pathname.includes('products.html')) {
                    const productCards = document.querySelectorAll('.product-card');
                    productCards.forEach(card => {
                        const name = card.querySelector('.product-name').textContent.toLowerCase();
                        const isVisible = name.includes(query);
                        card.style.display = isVisible ? 'block' : 'none';
                    });
                }

                if (query.length < 2) {
                    resultsPreview.innerHTML = '';
                    return;
                }

                const filtered = allProducts.filter(p =>
                    p.name.toLowerCase().includes(query) ||
                    p.category.toLowerCase().includes(query)
                );

                resultsPreview.innerHTML = filtered.map(p => `
                    <a href="product-detail.html?id=${p.id}" class="search-result-item">
                        <img src="${p.image}" class="search-result-img">
                        <div class="search-result-info">
                            <h4>${p.name}</h4>
                            <span>${p.category} | ${p.price}</span>
                        </div>
                    </a>
                `).join('');

                if (filtered.length === 0) {
                    resultsPreview.innerHTML = `<div style="text-align:center; padding: 20px;">${currentLang === 'ar' ? 'لا توجد نتائج مطابقة' : 'No matching results found'}</div>`;
                }
            });

            // Enter key to redirect to products page with query
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = searchInput.value;
                    if (query) {
                        const prefix = window.location.pathname.includes('/admin/') ? '../' : '';
                        window.location.href = `${prefix}products.html?search=${encodeURIComponent(query)}`;
                    }
                }
            });
        }
    };

    initSearch();


    // --- Toast Notification System ---
    const showToast = (message, type = 'success') => {
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-info-circle';

        toast.innerHTML = `
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px)';
            toast.style.transition = 'all 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    const showLogoutModal = () => {
        let overlay = document.querySelector('.logout-modal-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'logout-modal-overlay';
            overlay.innerHTML = `
                <div class="logout-modal">
                    <div class="logout-modal-icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <h3></h3>
                    <p></p>
                    <div class="logout-modal-actions">
                        <button class="btn btn-secondary cancel-logout"></button>
                        <button class="btn btn-primary confirm-logout" style="background: var(--danger-color); border-color: var(--danger-color);"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            overlay.querySelector('.cancel-logout').addEventListener('click', () => {
                overlay.classList.remove('active');
            });

            overlay.querySelector('.confirm-logout').addEventListener('click', () => {
                localStorage.removeItem('phoneStoreUser');
                overlay.classList.remove('active');
                showToast(currentLang === 'ar' ? 'تم تسجيل الخروج بنجاح' : 'Logged out successfully', 'success');
                setTimeout(() => {
                    const path = window.location.pathname;
                    const prefix = (path.includes('/admin/') || path.includes('/pages/')) ? '../' : '';
                    window.location.href = prefix + 'index.html';
                }, 500);
            });

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        }

        // Update text for current language
        overlay.querySelector('h3').textContent = translations[currentLang].logoutConfirmTitle || 'Sign Out';
        overlay.querySelector('p').textContent = translations[currentLang].logoutConfirm || 'Are you sure you want to sign out?';
        overlay.querySelector('.cancel-logout').textContent = translations[currentLang].cancel;
        overlay.querySelector('.confirm-logout').textContent = translations[currentLang].logout;

        setTimeout(() => overlay.classList.add('active'), 10);
    };

    // --- Universal Click Delegation ---
    document.addEventListener('click', (e) => {
        // User Dropdown Toggle
        const dropdownBtn = e.target.closest('.user-dropdown-btn');
        if (dropdownBtn) {
            e.preventDefault();
            const parent = dropdownBtn.closest('.user-dropdown-container');
            const menu = parent ? parent.querySelector('.user-dropdown-menu') : null;
            if (menu) {
                menu.classList.toggle('active');

                // Close other dropdowns
                document.querySelectorAll('.user-dropdown-menu').forEach(m => {
                    if (m !== menu) m.classList.remove('active');
                });
            }
            return;
        }

        // Close dropdown when clicking outside
        if (!e.target.closest('.user-dropdown-container')) {
            document.querySelectorAll('.user-dropdown-menu').forEach(m => m.classList.remove('active'));
        }

        // Logout Logic (Custom Modal)
        const logoutTrigger = e.target.closest('.logout-trigger-btn');
        if (logoutTrigger) {
            e.preventDefault();
            showLogoutModal();
            return;
        }

        // Admin Actions (Highest Priority)
        const adminBtn = e.target.closest('.admin-action-btn');
        if (adminBtn) {
            const action = adminBtn.dataset.action;
            if (action === 'add') {
                const modalId = adminBtn.dataset.modal || (window.location.pathname.includes('categories') ? 'addCategoryModal' : 'addProductModal');
                const modal = document.getElementById(modalId);
                const form = modal?.querySelector('form');

                if (modal && form) {
                    delete form.dataset.editId;
                    form.reset();

                    // Refresh categories list
                    if (typeof populateProductCategories === 'function') populateProductCategories();

                    // Clear custom handlers
                    if (typeof clearSelectedProductImages === 'function') clearSelectedProductImages();

                    const dynamicFields = document.getElementById('dynamicFieldsContainer');
                    if (dynamicFields) dynamicFields.style.display = 'none';

                    const title = modal.querySelector('.modal-title');
                    const submitBtn = form.querySelector('[type="submit"]');

                    if (window.location.pathname.includes('categories')) {
                        if (title) title.textContent = translations[currentLang].addNewCategory;
                    } else {
                        if (title) title.textContent = translations[currentLang].addNewProduct;
                    }
                    if (submitBtn) submitBtn.textContent = translations[currentLang].save;

                    modal.classList.add('active');
                } else if (modal) {
                    modal.classList.add('active');
                } else {
                    showToast(currentLang === 'ar' ? 'جاري فتح نموذج الإضافة...' : 'Opening add form...', 'info');
                }
            } else if (action === 'edit') {
                const id = adminBtn.dataset.id;
                if (!id) return;

                const isCategories = window.location.pathname.includes('categories');
                const modalId = isCategories ? 'addCategoryModal' : 'addProductModal';
                const modal = document.getElementById(modalId);
                const form = modal?.querySelector('form');

                if (modal && form) {
                    // Record we are in edit mode
                    form.dataset.editId = id;

                    // Refresh categories list
                    if (typeof populateProductCategories === 'function') populateProductCategories();

                    // Update UI titles/buttons
                    const title = modal.querySelector('.modal-title');
                    const submitBtn = form.querySelector('[type="submit"]');

                    if (isCategories) {
                        const cat = allCategories.find(c => c.id == id);
                        if (cat) {
                            form.name.value = cat.name;
                            if (title) title.textContent = currentLang === 'ar' ? 'تعديل القسم' : 'Edit Category';
                            if (submitBtn) submitBtn.textContent = currentLang === 'ar' ? 'تحديث' : 'Update';
                            modal.classList.add('active');
                        }
                    } else {
                        const prod = allProducts.find(p => p.id == id);
                        if (prod) {
                            form.name.value = prod.name;
                            form.category.value = prod.category;
                            form.price.value = prod.price;
                            form.stock.value = prod.stock;
                            form.description.value = prod.description || '';

                            // Set new fields
                            if (form.inStock) form.inStock.checked = !!prod.in_stock;
                            if (form.storage) form.storage.value = prod.storage || '';
                            if (form.color) form.color.value = prod.color || '';

                            // Trigger category change logic to show dynamic fields and load brands
                            const categorySelect = document.getElementById('productCategorySelect');
                            if (categorySelect) {
                                categorySelect.dispatchEvent(new Event('change'));

                                // Set brand after a short delay to allow brands to load
                                setTimeout(() => {
                                    if (form.brand) form.brand.value = prod.brand || '';
                                }, 500);
                            }

                            // Show current images in preview
                            const imagesPreview = document.getElementById('imagesPreview');
                            if (imagesPreview) {
                                imagesPreview.innerHTML = '';
                                const images = prod.images || [prod.image];
                                images.filter(img => img).forEach(imgUrl => {
                                    const div = document.createElement('div');
                                    div.className = 'image-preview-item';
                                    div.innerHTML = `
                                        <img src="${imgUrl}" alt="Preview">
                                    `;
                                    imagesPreview.appendChild(div);
                                });
                            }

                            if (title) title.textContent = currentLang === 'ar' ? 'تعديل المنتج' : 'Edit Product';
                            if (submitBtn) submitBtn.textContent = currentLang === 'ar' ? 'تحديث' : 'Update';
                            modal.classList.add('active');
                        }
                    }
                }
            } else if (action === 'view') {
                showToast(currentLang === 'ar' ? 'جاري عرض تفاصيل العنصر...' : 'Showing item details...', 'info');
            } else if (action === 'delete') {
                const id = adminBtn.dataset.id;
                if (!id) return;

                if (confirm(currentLang === 'ar' ? 'هل أنت متأكد من الحذف؟' : 'Are you sure you want to delete?')) {
                    const row = adminBtn.closest('tr') || adminBtn.closest('.glass-card');
                    if (row) {
                        row.style.opacity = '0.5';

                        (async () => {
                            let success = false;
                            if (window.location.pathname.includes('categories')) {
                                success = await deleteCategory(id);
                            } else {
                                success = await deleteProduct(id);
                            }

                            if (success) {
                                showToast(currentLang === 'ar' ? 'تم الحذف بنجاح' : 'Deleted successfully');
                                row.remove();
                            } else {
                                row.style.opacity = '1';
                                showToast(currentLang === 'ar' ? 'حدث خطأ أثناء الحذف' : 'Error during deletion', 'error');
                            }
                        })();
                    }
                }
            }
            return; // Stop processing other delegation if it's an admin action
        }

        // Add to Cart
        const addToCartBtn = e.target.closest('.btn-primary');
        if (addToCartBtn && (addToCartBtn.closest('.product-card') || addToCartBtn.closest('.product-detail-area') || addToCartBtn.closest('.hero-buttons')) && addToCartBtn.dataset.i18n === 'addToCart') {
            const productCard = addToCartBtn.closest('.product-card') || addToCartBtn.closest('.product-detail-area');
            let productId;

            if (productCard) {
                productId = productCard.querySelector('.wishlist-btn')?.dataset.id || new URLSearchParams(window.location.search).get('id');
            }

            const product = allProducts.find(p => p.id == productId);
            if (product) {
                const qtyInput = productCard.querySelector('#productQty') || productCard.querySelector('.qty-input');
                const quantityToAdd = qtyInput ? parseInt(qtyInput.value || qtyInput.textContent) || 1 : 1;

                const existingItem = cartItems.find(item => item.id == product.id);
                if (existingItem) {
                    existingItem.quantity += quantityToAdd;
                } else {
                    cartItems.push({ ...product, quantity: quantityToAdd });
                }
                localStorage.setItem('phoneStoreCart', JSON.stringify(cartItems));
                updateCartCount();
                showToast(currentLang === 'ar' ? 'تمت الإضافة إلى السلة بنجاح!' : 'Added to cart successfully!');
            } else {
                // If product object not found directly (e.g. from a static link), just show toast as fallback
                showToast(currentLang === 'ar' ? 'سلة التسوق ستتوفر قريباً!' : 'Shopping cart coming soon!', 'info');
            }
            return;
        }

        // Wishlist Toggle Logic
        const wishlistBtn = e.target.closest('.wishlist-btn');
        if (wishlistBtn) {
            e.preventDefault();
            const id = wishlistBtn.dataset.id;
            const product = allProducts.find(p => p.id == id) || wishlistItems.find(p => p.id == id);

            if (!product) return;

            const index = wishlistItems.findIndex(item => item.id == id);
            const icon = wishlistBtn.querySelector('i');

            if (index === -1) {
                wishlistItems.push(product);
                wishlistBtn.classList.add('active');
                if (icon) icon.className = 'fas fa-heart';
                showToast(currentLang === 'ar' ? translations.ar.addedToWishlist : translations.en.addedToWishlist);
            } else {
                wishlistItems.splice(index, 1);
                wishlistBtn.classList.remove('active');
                if (icon) icon.className = 'far fa-heart';
                showToast(currentLang === 'ar' ? translations.ar.removedFromWishlist : translations.en.removedFromWishlist);
            }

            localStorage.setItem('phoneStoreWishlist', JSON.stringify(wishlistItems));
            updateWishlistCount(wishlistItems.length);

            if (window.location.pathname.includes('favorites.html')) {
                renderFavorites();
            }
            return;
        }

        const actionBtn = e.target.closest('.product-action-btn');
        if (actionBtn) {
            // Heart (Wishlist)
            if (actionBtn.querySelector('.fa-heart') || actionBtn.classList.contains('fa-heart')) {
                actionBtn.classList.toggle('active');
                const isActive = actionBtn.classList.contains('active');
                if (isActive) {
                    showToast(currentLang === 'ar' ? 'تمت الإضافة للمفضلة' : 'Added to wishlist');
                } else {
                    showToast(currentLang === 'ar' ? 'تم الحذف من المفضلة' : 'Removed from wishlist', 'info');
                }
            }
            // View (Eye)
            if (actionBtn.querySelector('.fa-eye') || actionBtn.classList.contains('fa-eye')) {
                showToast(currentLang === 'ar' ? 'جاري عرض تفاصيل المنتج...' : 'Showing product details...', 'info');
                setTimeout(() => {
                    const prefix = window.location.pathname.includes('/admin/') ? '../' : '';
                    window.location.href = prefix + 'product-detail.html';
                }, 800);
            }
            return;
        }

        // Cart Page Actions
        const removeBtn = e.target.closest('.remove-btn');
        if (removeBtn) {
            const cartItem = removeBtn.closest('.cart-item');
            if (cartItem) {
                cartItem.style.opacity = '0';
                cartItem.style.transform = 'translateX(20px)';
                cartItem.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                    const id = cartItem.dataset.id;
                    const index = cartItems.findIndex(i => i.id == id);
                    if (index !== -1) {
                        cartItems.splice(index, 1);
                        localStorage.setItem('phoneStoreCart', JSON.stringify(cartItems));
                        updateCartCount();
                    }
                    cartItem.remove();
                    updateCartTotals();
                    showToast(currentLang === 'ar' ? 'تم حذف المنتج من السلة' : 'Item removed from cart', 'info');
                }, 300);
            }
            return;
        }

        const qtyBtn = e.target.closest('.qty-btn-sm, .qty-btn');
        if (qtyBtn) {
            const container = qtyBtn.parentElement;
            const qtyInput = container.querySelector('.qty-text, .qty-input');
            const cartItem = qtyBtn.closest('.cart-item');

            if (qtyInput) {
                let currentQty = parseInt(qtyInput.value || qtyInput.textContent);
                if (qtyBtn.textContent.trim() === '+') {
                    currentQty++;
                } else if (qtyBtn.textContent.trim() === '-' && currentQty > 1) {
                    currentQty--;
                }

                if (cartItem) {
                    const id = cartItem.dataset.id;
                    const item = cartItems.find(i => i.id == id);
                    if (item) {
                        item.quantity = currentQty;
                        localStorage.setItem('phoneStoreCart', JSON.stringify(cartItems));
                        updateCartCount();
                    }
                }

                if (qtyInput.tagName === 'INPUT') {
                    qtyInput.value = currentQty;
                } else {
                    qtyInput.textContent = currentQty;
                }
                updateCartTotals();
            }
            return;
        }

        // Global Feedback
        if (e.target.closest('.newsletter-btn')) {
            showToast(currentLang === 'ar' ? 'شكراً لاشتراكك في النشرة الإخبارية!' : 'Thanks for subscribing to our newsletter!');
        }
        if (e.target.closest('.filter-submit-btn')) {
            showToast(currentLang === 'ar' ? 'تم تطبيق الفلاتر بنجاح' : 'Filters applied successfully');
        }
        if (e.target.closest('.page-btn')) {
            const pageBtn = e.target.closest('.page-btn');
            showToast(currentLang === 'ar' ? `جاري تحميل الصفحة ${pageBtn.dataset.page || pageBtn.textContent}...` : `Loading page ${pageBtn.dataset.page || pageBtn.textContent}...`, 'info');
        }
        if (e.target.closest('.option-btn')) {
            const optionBtn = e.target.closest('.option-btn');
            optionBtn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
            optionBtn.classList.add('active');
            showToast(currentLang === 'ar' ? `تم اختيار: ${optionBtn.textContent}` : `Selected: ${optionBtn.textContent}`, 'info');
        }

        if (e.target.closest('.alert-btn')) {
            showToast(currentLang === 'ar' ? 'لا توجد تنبيهات جديدة' : 'No new notifications', 'info');
        }

        // Modal Close
        if (e.target.closest('.modal-close') || e.target.closest('.modal-close-btn') || (e.target.classList.contains('modal-overlay'))) {
            const modal = e.target.closest('.modal-overlay');
            if (modal) modal.classList.remove('active');
            return;
        }
    });

    const updateCartTotals = () => {
        const subtotalElement = document.querySelector('.summary-row span:last-child');
        const totalElement = document.querySelector('.summary-total span:last-child');

        if (!subtotalElement || !totalElement) return;

        let total = cartItems.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);

        const formattedTotal = total.toLocaleString() + ' $';
        subtotalElement.textContent = formattedTotal;
        totalElement.textContent = formattedTotal;

        if (cartItems.length === 0) {
            const container = document.querySelector('.cart-items');
            if (container) {
                container.innerHTML = `
                    <div class="glass-card text-center" style="padding: var(--spacing-xxl);">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; color: var(--text-muted);"></i>
                        <p>${currentLang === 'ar' ? 'سلة التسوق فارغة حالياً' : 'Your cart is currently empty'}</p>
                    </div>
                `;
            }
        }
    };

    const renderCartItems = () => {
        const container = document.querySelector('.cart-items');
        if (!container) return;

        if (cartItems.length === 0) {
            updateCartTotals();
            return;
        }

        container.innerHTML = cartItems.map(item => `
            <div class="glass-card cart-item" data-id="${item.id}">
                <div class="cart-item-img">
                    <img src="${item.image}" alt="${item.name}">
                </div>
                <div class="cart-item-info">
                    <h3>${escapeHTML(item.name)}</h3>
                    <p>${item.storage || ''} | ${item.color || ''}</p>
                </div>
                <div class="cart-item-qty">
                    <button class="btn btn-primary qty-btn-sm">-</button>
                    <span class="qty-text">${item.quantity}</span>
                    <button class="btn btn-primary qty-btn-sm">+</button>
                </div>
                <div class="cart-item-price current-price">
                    $${(parseFloat(item.price) * item.quantity).toLocaleString()}
                </div>
                <div class="cart-item-remove">
                    <button class="remove-btn"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');

        updateCartTotals();
    };

    renderCartItems();

    // Form Simulation Handling
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = form.querySelector('[type="submit"]');
            const originalText = submitBtn.textContent;

            // Specialized handling for Add Product Form
            if (form.id === 'addProductForm') {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // Get selected images from our custom handler
                const imageFiles = typeof getSelectedProductImages === 'function' ? getSelectedProductImages() : [];

                submitBtn.disabled = true;
                submitBtn.textContent = currentLang === 'ar' ? 'جاري الرفع...' : 'Uploading...';

                // Insert/Update in Supabase with file upload
                (async () => {
                    const editId = form.dataset.editId;
                    let existingProd = editId ? allProducts.find(p => p.id == editId) : null;
                    let imageUrls = existingProd ? (existingProd.images || [existingProd.image]) : [];

                    // Validate images for new items
                    if (!editId && imageFiles.length === 0) {
                        showToast(currentLang === 'ar' ? 'يرجى اختيار صورة واحدة على الأقل' : 'Please select at least one image', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }

                    // Upload images if selected
                    if (imageFiles.length > 0) {
                        submitBtn.textContent = currentLang === 'ar' ? 'جاري رفع الصور...' : 'Uploading images...';
                        const uploadedUrls = typeof uploadMultipleImages === 'function'
                            ? await uploadMultipleImages(imageFiles, 'categories')
                            : [];

                        if (uploadedUrls.length === 0) {
                            showToast(currentLang === 'ar' ? 'فشل رفع الصور' : 'Image upload failed', 'error');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            return;
                        }
                        imageUrls = uploadedUrls;
                    }

                    submitBtn.textContent = currentLang === 'ar' ? 'جاري الحفظ...' : 'Saving...';

                    // Build product data with new fields
                    const productData = {
                        name: data.name,
                        category: data.category,
                        price: parseFloat(data.price),
                        in_stock: data.inStock === 'on',
                        image: imageUrls[0] || '',
                        images: imageUrls,
                        description: data.description || '',
                        brand: data.brand || null,
                        storage: data.storage || null,
                        color: data.color || null
                    };

                    let result;
                    if (editId) {
                        result = await updateProduct(editId, productData);
                    } else {
                        result = await addProduct(productData);
                    }

                    if (result) {
                        if (editId) {
                            // Update existing row
                            const row = document.querySelector(`tr[data-id="${editId}"]`);
                            if (row) {
                                const categoryObj = allCategories.find(c => c.id === result.category);
                                const categoryName = categoryObj ? categoryObj.name : result.category;

                                row.innerHTML = `
                                    <td class="flex" style="gap: 10px; align-items: center;">
                                        <img src="${result.image}" class="product-img-table" onerror="this.src='https://via.placeholder.com/50'">
                                        <span>${result.name}</span>
                                    </td>
                                    <td>${categoryName}</td>
                                    <td>$${parseFloat(result.price).toLocaleString()}</td>
                                    <td>
                                        <span class="status-badge ${result.in_stock ? 'status-completed' : 'status-failed'}">
                                            ${result.in_stock ? (translations[currentLang].inStock || 'متوفر') : (translations[currentLang].outOfStock || 'نفذت')}
                                        </span>
                                    </td>
                                    <td><span class="status-badge status-completed" data-i18n="active">${translations[currentLang].active}</span></td>
                                    <td>
                                        <div class="action-btns">
                                            <button class="admin-action-btn" data-action="edit" data-id="${result.id}" style="color: var(--accent-color);"><i class="fas fa-edit"></i></button>
                                            <button class="admin-action-btn" data-action="delete" data-id="${result.id}" style="color: var(--danger-color);"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                `;
                                row.style.animation = 'none';
                                void row.offsetWidth; // Trigger reflow
                                row.style.animation = 'fadeInUp 0.5s ease forwards';
                            }

                            // Update allProducts local cache
                            const idx = allProducts.findIndex(p => p.id == editId);
                            if (idx !== -1) allProducts[idx] = result;

                            showToast(currentLang === 'ar' ? 'تم تحديث المنتج بنجاح!' : 'Product updated successfully!');
                        } else {
                            // Add to admin table
                            const tbody = document.querySelector('table tbody');
                            if (tbody) {
                                // Remove empty state if exists
                                const emptyState = document.querySelector('.admin-table-container > .text-center');
                                if (emptyState) emptyState.remove();

                                const categoryObj = allCategories.find(c => c.id === result.category);
                                const categoryName = categoryObj ? categoryObj.name : result.category;

                                const newRow = document.createElement('tr');
                                newRow.dataset.id = result.id;
                                newRow.style.animation = 'fadeInUp 0.5s ease forwards';
                                newRow.innerHTML = `
                                    <td class="flex" style="gap: 10px; align-items: center;">
                                        <img src="${result.image}" class="product-img-table" onerror="this.src='https://via.placeholder.com/50'">
                                        <span>${result.name}</span>
                                    </td>
                                    <td>${categoryName}</td>
                                    <td>$${parseFloat(result.price).toLocaleString()}</td>
                                    <td>
                                        <span class="status-badge ${result.in_stock ? 'status-completed' : 'status-failed'}">
                                            ${result.in_stock ? (translations[currentLang].inStock || 'متوفر') : (translations[currentLang].outOfStock || 'نفذت')}
                                        </span>
                                    </td>
                                    <td><span class="status-badge status-completed" data-i18n="active">${translations[currentLang].active}</span></td>
                                    <td>
                                        <div class="action-btns">
                                            <button class="admin-action-btn" data-action="edit" data-id="${result.id}" style="color: var(--accent-color);"><i class="fas fa-edit"></i></button>
                                            <button class="admin-action-btn" data-action="delete" data-id="${result.id}" style="color: var(--danger-color);"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                `;
                                tbody.prepend(newRow);
                            }
                            allProducts.unshift(result);
                            showToast(currentLang === 'ar' ? 'تم إضافة المنتج بنجاح!' : 'Product added successfully!');
                        }

                        form.reset();
                        delete form.dataset.editId;

                        const modal = form.closest('.modal-overlay');
                        if (modal) modal.classList.remove('active');
                    } else {
                        showToast(currentLang === 'ar' ? 'حدث خطأ أثناء العملية' : 'Error during operation', 'error');
                    }

                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                })();
                return;
            }

            // Specialized handling for Add Category Form
            if (form.id === 'addCategoryForm') {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                const imageFile = form.querySelector('input[name="imageFile"]')?.files[0];

                submitBtn.disabled = true;
                submitBtn.textContent = currentLang === 'ar' ? 'جاري الرفع...' : 'Uploading...';

                // Insert/Update in Supabase with file upload
                (async () => {
                    const editId = form.dataset.editId;
                    let existingCat = editId ? allCategories.find(c => c.id == editId) : null;
                    let imageUrl = existingCat ? (existingCat.image || '') : '';

                    // Validate image for new items
                    if (!editId && !imageFile) {
                        showToast(currentLang === 'ar' ? 'يرجى اختيار صورة للقسم' : 'Please select a category image', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }

                    // Upload image if selected
                    if (imageFile) {
                        submitBtn.textContent = currentLang === 'ar' ? 'جاري رفع الصورة...' : 'Uploading image...';
                        imageUrl = await uploadImage(imageFile, 'categories');
                        if (!imageUrl) {
                            showToast(currentLang === 'ar' ? 'فشل رفع الصورة' : 'Image upload failed', 'error');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            return;
                        }
                    }

                    submitBtn.textContent = currentLang === 'ar' ? 'جاري الحفظ...' : 'Saving...';

                    const categoryData = {
                        name: data.name,
                        image: imageUrl
                    };

                    // Only add count for new categories
                    if (!editId) {
                        categoryData.count = 0;
                    }

                    let result;
                    if (editId) {
                        result = await updateCategory(editId, categoryData);
                    } else {
                        result = await addCategory(categoryData);
                    }

                    if (result) {
                        if (editId) {
                            // Update existing card
                            const card = document.querySelector(`.glass-card[data-id="${editId}"]`);
                            if (card) {
                                const imageHtml = result.image
                                    ? `<img src="${result.image}" alt="${result.name}" style="width: 50px; height: 50px; border-radius: var(--radius-md); object-fit: cover;">`
                                    : `<div class="category-icon" style="width: 50px; height: 50px; font-size: 1.25rem;"><i class="fas fa-folder"></i></div>`;

                                card.innerHTML = `
                                    <div class="flex" style="gap: 15px; align-items: center;">
                                        ${imageHtml}
                                        <div>
                                            <h3 style="font-size: 1.125rem;">${result.name}</h3>
                                        </div>
                                    </div>
                                    <div class="action-btns">
                                        <button class="admin-action-btn" data-action="edit" data-id="${result.id}" style="color: var(--accent-color); margin-left:10px;"><i class="fas fa-edit"></i></button>
                                        <button class="admin-action-btn" data-action="delete" data-id="${result.id}" style="color: var(--danger-color);"><i class="fas fa-trash"></i></button>
                                    </div>
                                `;
                                card.style.animation = 'none';
                                void card.offsetWidth;
                                card.style.animation = 'fadeInUp 0.5s ease forwards';
                            }
                            // Update cache
                            const idx = allCategories.findIndex(c => c.id == editId);
                            if (idx !== -1) allCategories[idx] = result;

                            showToast(currentLang === 'ar' ? 'تم تحديث القسم بنجاح!' : 'Category updated successfully!');
                        } else {
                            // Add to admin grid
                            const grid = document.getElementById('categoryGridAdmin');
                            if (grid) {
                                // Remove empty state if exists
                                const emptyState = grid.querySelector('.text-center');
                                if (emptyState) emptyState.remove();

                                const imageHtml = result.image
                                    ? `<img src="${result.image}" alt="${result.name}" style="width: 50px; height: 50px; border-radius: var(--radius-md); object-fit: cover;">`
                                    : `<div class="category-icon" style="width: 50px; height: 50px; font-size: 1.25rem;"><i class="fas fa-folder"></i></div>`;

                                const newCard = document.createElement('div');
                                newCard.className = 'glass-card flex-between';
                                newCard.dataset.id = result.id;
                                newCard.style.padding = '1.5rem';
                                newCard.style.animation = 'fadeInUp 0.5s ease forwards';
                                newCard.innerHTML = `
                                    <div class="flex" style="gap: 15px; align-items: center;">
                                        ${imageHtml}
                                        <div>
                                            <h3 style="font-size: 1.125rem;">${result.name}</h3>
                                        </div>
                                    </div>
                                    <div class="action-btns">
                                        <button class="admin-action-btn" data-action="edit" data-id="${result.id}" style="color: var(--accent-color); margin-left:10px;"><i class="fas fa-edit"></i></button>
                                        <button class="admin-action-btn" data-action="delete" data-id="${result.id}" style="color: var(--danger-color);"><i class="fas fa-trash"></i></button>
                                    </div>
                                `;
                                grid.prepend(newCard);
                            }
                            allCategories.unshift(result);
                            showToast(currentLang === 'ar' ? 'تم إضافة القسم بنجاح!' : 'Category added successfully!');
                        }

                        form.reset();
                        delete form.dataset.editId;

                        const modal = form.closest('.modal-overlay');
                        if (modal) modal.classList.remove('active');
                    } else {
                        showToast(currentLang === 'ar' ? 'حدث خطأ أثناء العملية' : 'Error during operation', 'error');
                    }

                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                })();
                return;
            }

            // Specialized handling for Settings Form
            if (form.id === 'settingsForm') {
                const storeNameInput = document.getElementById('storeNameInput');
                if (storeNameInput) {
                    siteName = storeNameInput.value;
                    localStorage.setItem('phoneStoreName', siteName);
                    updateBranding();
                }

                const heroImageInput = document.getElementById('heroImageInput');
                const heroLinkInput = document.getElementById('heroLinkInput');

                (async () => {
                    submitBtn.disabled = true;
                    submitBtn.textContent = currentLang === 'ar' ? 'جاري الحفظ...' : 'Saving...';

                    if (heroLinkInput) {
                        localStorage.setItem('phoneStoreHeroLink', heroLinkInput.value);
                    }

                    if (heroImageInput && heroImageInput.files[0]) {
                        submitBtn.textContent = currentLang === 'ar' ? 'جاري رفع الصورة...' : 'Uploading image...';
                        const url = await uploadImage(heroImageInput.files[0], 'categories');
                        if (url) {
                            localStorage.setItem('phoneStoreHeroImage', url);
                        } else {
                            showToast(currentLang === 'ar' ? 'فشل رفع الصورة' : 'Image upload failed', 'error');
                        }
                    }

                    showToast(currentLang === 'ar' ? 'تم حفظ الإعدادات بنجاح!' : 'Settings saved successfully!');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;

                    // Update preview if exists
                    const preview = document.getElementById('heroPreview');
                    const savedImg = localStorage.getItem('phoneStoreHeroImage');
                    if (preview && savedImg) {
                        preview.innerHTML = `<img src="${savedImg}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    }
                })();
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = currentLang === 'ar' ? 'جاري المعالجة...' : 'Processing...';

            setTimeout(() => {
                showToast(currentLang === 'ar' ? 'تمت العملية بنجاح!' : 'Operation successful!');

                // Redirect logic based on form type (simplified)
                const emailInput = form.querySelector('input[type="email"]');
                const isAuthForm = form.closest('.auth-container') || form.closest('#authModal') || form.id === 'loginForm' || form.id === 'registerForm';

                if (isAuthForm && emailInput) {
                    const emailValue = emailInput.value.trim().toLowerCase();
                    const path = window.location.pathname;
                    const prefix = (path.includes('/admin/') || path.includes('/pages/')) ? '../' : '';

                    if (emailValue === 'admin@store.com') {
                        const passwordInput = form.querySelector('input[type="password"]');
                        if (passwordInput && passwordInput.value === 'admin123') {
                            localStorage.setItem('phoneStoreUser', 'admin');
                            showToast(currentLang === 'ar' ? 'مرحباً بك مدير الموقع...' : 'Welcome Admin...', 'success');
                            setTimeout(() => {
                                window.location.href = prefix + 'admin-products.html';
                            }, 500);
                        } else {
                            showToast(currentLang === 'ar' ? 'كلمة المرور غير صحيحة' : 'Invalid password', 'error');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    } else {
                        localStorage.setItem('phoneStoreUser', emailValue);
                        window.location.href = prefix + 'index.html';
                    }
                } else if (window.location.pathname.includes('contact')) {
                    form.reset();
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                } else if (window.location.pathname.includes('checkout')) {
                    // Clear Cart
                    localStorage.removeItem('phoneStoreCart');
                    cartItems = [];
                    updateCartCount();
                    window.location.href = 'order-success.html';
                }
            }, 1000);
        });
    });

    // --- Auth Modal System ---
    const initAuthModal = () => {
        if (document.getElementById('authModal')) return;

        const modal = document.createElement('div');
        modal.id = 'authModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content animate-fadeInUp">
                <div class="modal-close"><i class="fas fa-times"></i></div>
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login" data-i18n="login">${translations[currentLang].login}</div>
                    <div class="auth-tab" data-tab="register" data-i18n="register">${translations[currentLang].register}</div>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form active">
                    <div class="form-group">
                        <label class="form-label" data-i18n="email">البريد الإلكتروني</label>
                        <input type="email" class="form-input" placeholder="example@mail.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="password">كلمة المرور</label>
                        <input type="password" class="form-input" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;" data-i18n="login">${translations[currentLang].login}</button>
                    <div class="auth-footer">
                        <p data-i18n="forgotPassword">نسيت كلمة المرور؟</p>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label" data-i18n="fullName">الاسم الكامل</label>
                        <input type="text" class="form-input" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="email">البريد الإلكتروني</label>
                        <input type="email" class="form-input" placeholder="example@mail.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="password">كلمة المرور</label>
                        <input type="password" class="form-input" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;" data-i18n="register">${translations[currentLang].register}</button>
                </form>
            </div>
        `;
        document.body.appendChild(modal);

        // Modal Logic
        const closeBtn = modal.querySelector('.modal-close');
        const tabs = modal.querySelectorAll('.auth-tab');
        const forms = modal.querySelectorAll('.auth-form');

        const closeModal = () => modal.classList.remove('active');

        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                tabs.forEach(t => t.classList.remove('active'));
                forms.forEach(f => f.classList.remove('active'));

                tab.classList.add('active');
                modal.querySelector(`#${target}Form`).classList.add('active');
            });
        });

        // --- Form Submit Handlers for Modal Forms ---
        forms.forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const submitBtn = form.querySelector('[type="submit"]');
                const originalText = submitBtn.textContent;
                const emailInput = form.querySelector('input[type="email"]');

                submitBtn.disabled = true;
                submitBtn.textContent = currentLang === 'ar' ? 'جاري المعالجة...' : 'Processing...';

                setTimeout(() => {
                    if (emailInput) {
                        const emailValue = emailInput.value.trim().toLowerCase();
                        const path = window.location.pathname;
                        const prefix = (path.includes('/admin/') || path.includes('/pages/')) ? '../' : '';

                        if (emailValue === 'admin@store.com') {
                            const passwordInput = form.querySelector('input[type="password"]');
                            if (passwordInput && passwordInput.value === 'admin123') {
                                localStorage.setItem('phoneStoreUser', 'admin');
                                showToast(currentLang === 'ar' ? 'مرحباً بك مدير الموقع...' : 'Welcome Admin...', 'success');
                                setTimeout(() => {
                                    window.location.href = prefix + 'admin-products.html';
                                }, 500);
                            } else {
                                showToast(currentLang === 'ar' ? 'كلمة المرور غير صحيحة' : 'Invalid password', 'error');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        } else {
                            localStorage.setItem('phoneStoreUser', emailValue);
                            showToast(currentLang === 'ar' ? 'تم تسجيل الدخول بنجاح' : 'Login successful!', 'success');
                            setTimeout(() => {
                                window.location.href = prefix + 'index.html';
                            }, 500);
                        }
                    } else {
                        // Register form without email (unlikely, but fallback)
                        showToast(currentLang === 'ar' ? 'تمت العملية بنجاح!' : 'Operation successful!');
                        closeModal();
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }, 1000);
            });
        });
    };

    // Trigger Auth Modal
    document.addEventListener('click', (e) => {
        if (e.target.closest('.login-trigger-btn')) {
            e.preventDefault();
            const modal = document.getElementById('authModal');
            if (modal) modal.classList.add('active');
        }
    });

    // Make showToast available globally if needed
    window.showToast = showToast;

    // --- Dynamic Product Detail Loader ---
    const loadProductDetail = async () => {
        if (!window.location.pathname.includes('product-detail.html')) return;

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        if (!productId) return;

        // Fetch products if not loaded
        if (allProducts.length === 0 && typeof fetchProducts === 'function') {
            allProducts = await fetchProducts();
        }

        const product = allProducts.find(p => p.id === productId);
        if (!product) {
            showToast(currentLang === 'ar' ? 'المنتج غير موجود' : 'Product not found', 'error');
            return;
        }

        // Update Page Content
        const titleEl = document.getElementById('productTitle');
        const brandLgEl = document.getElementById('productCategoryLg');
        const priceEl = document.getElementById('currentPrice');
        const descEl = document.getElementById('productDescription');
        const mainImg = document.getElementById('mainImg');
        const availabilityEl = document.getElementById('availabilityStatus');
        const thumbContainer = document.getElementById('thumbImages');
        const storageContainer = document.getElementById('storageContainer');
        const storageOptions = document.getElementById('storageOptions');
        const colorContainer = document.getElementById('colorContainer');
        const colorOptions = document.getElementById('colorOptions');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const wishlistBtn = document.getElementById('wishlistBtnDetail');

        if (titleEl) titleEl.textContent = product.name;

        // Load category name for brand label
        if (brandLgEl) {
            if (allCategories.length === 0 && typeof fetchCategories === 'function') {
                allCategories = await fetchCategories();
            }
            const cat = allCategories.find(c => c.id === product.category);
            brandLgEl.textContent = cat ? cat.name.toUpperCase() : (product.category || '').toUpperCase();
        }

        if (priceEl) priceEl.textContent = `$${parseFloat(product.price).toLocaleString()}`;
        if (descEl) descEl.textContent = product.description;

        if (mainImg) {
            mainImg.src = product.image;
            mainImg.alt = product.name;
        }

        // Availability
        if (availabilityEl) {
            const isAvailable = product.in_stock !== false;
            availabilityEl.innerHTML = isAvailable
                ? `<i class="fas fa-check-circle"></i> ${translations[currentLang].inStock || 'متوفر في المخزن'}`
                : `<i class="fas fa-times-circle"></i> ${translations[currentLang].outOfStock || 'نفذت الكمية'}`;
            availabilityEl.style.color = isAvailable ? 'var(--success-color)' : 'var(--danger-color)';
            if (addToCartBtn) {
                addToCartBtn.disabled = !isAvailable;
                if (!isAvailable) addToCartBtn.style.opacity = '0.5';
            }
        }

        // Multiple Images
        if (thumbContainer) {
            const images = product.images || [product.image];
            if (images.length > 1) {
                thumbContainer.innerHTML = images.map((img, i) => `
                    <div class="thumb ${i === 0 ? 'active' : ''}">
                        <img src="${img}" alt="Thumb ${i + 1}" onclick="document.getElementById('mainImg').src='${img}'; document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active')); this.parentElement.classList.add('active');">
                    </div>
                `).join('');
            } else {
                thumbContainer.style.display = 'none';
            }
        }

        // Storage
        if (product.storage && storageContainer && storageOptions) {
            storageContainer.style.display = 'block';
            storageOptions.innerHTML = `<button class="option-btn active">${product.storage}</button>`;
        }

        // Color
        if (product.color && colorContainer && colorOptions) {
            colorContainer.style.display = 'block';
            colorOptions.innerHTML = `<button class="option-btn active">${product.color}</button>`;
        }

        // Wishlist State for Detail Page
        if (wishlistBtn) {
            wishlistBtn.dataset.id = product.id;
            const isWishlisted = wishlistItems.some(item => item.id === product.id);
            wishlistBtn.innerHTML = `<i class="${isWishlisted ? 'fas' : 'far'} fa-heart"></i>`;
            if (isWishlisted) wishlistBtn.classList.add('active');
        }

        // Update tab title
        document.title = `${product.name} | ${siteName}`;
    };

    loadProductDetail();

    // --- Dynamic Navbar & Scroll Reveal ---
    const handleScroll = () => {
        const header = document.querySelector('.header');
        if (header) {
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        }
    };

    window.addEventListener('scroll', handleScroll);

    // Scroll Reveal Intersection Observer
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('revealed');
                revealObserver.unobserve(entry.target);
            }
        });
    }, observerOptions);

    const initScrollReveal = () => {
        const elements = document.querySelectorAll('.animate-fadeInUp, .animate-fadeIn, .section-title, .glass-card');
        elements.forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            el.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
            revealObserver.observe(el);
        });
    };

    // Add CSS for revealed state
    const revealStyles = document.createElement('style');
    revealStyles.textContent = `
        .revealed {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
    `;
    document.head.appendChild(revealStyles);

    initScrollReveal();
    handleScroll();

    // Final Init calls
    initApp();
    initAuthModal();
});

